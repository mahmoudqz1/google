function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify(fetchEmailData()))
    .setMimeType(ContentService.MimeType.JSON);
}

// Main function to fetch email data
function fetchEmailData() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var searchQuery = 'label:Lead'; // Replace with your desired search criteria

  // Clear existing data
  sheet.getDataRange().clearContent();

  // Set the headings in the first row
  sheet.getRange("A1:N1").setValues([[
    "Type d'assurance", "Time", "Nom", "Prénom", "Email", "Téléphone",
    "Date de Naissance", "Code Postal", "Type de permis", "Type d'usage",
    "Type d'habitation", "Qualité d'occupation", "Type de conducteur", "Nature de prêt"
  ]]);

  var threads = GmailApp.search(searchQuery);
  var data = [];

  for (var i = 0; i < threads.length; i++) {
    var messages = threads[i].getMessages();

    for (var j = 0; j < messages.length; j++) {
      var email = messages[j];
      var subject = email.getSubject();
      var time = email.getDate();

      // Extracting fields from the email body
      var body = email.getPlainBody();
      var emailShape = extractEmailFromBody(body);

      var date_de_naissance = extractValueFromBody(body, "date de naissance");
      var Nom = extractValueFromBody(body, "Nom");
      var Prenom = extractValueFromBody(body, "Prénom");
      var Tel = extractValueFromBody(body, "Tél");
      var Code_postale = extractValueFromBody(body, "Code postale");
      var Type_usage = extractValueFromBody(body, "Type d'usage") || extractValueFromBody(body, "Type");
      var Type_de_permis = extractValueFromBody(body, "Type de permis");
      var Type_habitation = extractValueFromBody(body, "Type d'habitation");
      var Qualite_occupation = extractValueFromBody(body, "Qualité d'occupation");
      var Type_conducteur = extractValueFromBody(body, "Type de conducteur");
      var Nature_pret = extractValueFromBody(body, "Nature de prêt");

      // Determine the type of assurance based on fields
      var type_assurance = "UNKNOWN";
      if (Nom && Prenom && emailShape && Tel && Type_usage) {
        type_assurance = "AUTO";
      } else if (Nom && Prenom && emailShape && Tel && date_de_naissance && Code_postale && Type_de_permis && Type_usage) {
        type_assurance = "MOTO";
      } else if (Nom && Prenom && emailShape && Tel && date_de_naissance && Code_postale && Type_habitation && Qualite_occupation) {
        type_assurance = "HABITATION";
      } else if (Nom && Prenom && emailShape && Tel && date_de_naissance && Code_postale && Type_conducteur) {
        type_assurance = "VTC";
      } else if (Nom && Prenom && emailShape && Tel && date_de_naissance && Code_postale && Nature_pret) {
        type_assurance = "EMPRUNTEUR";
      }

      // Add the data to the array
      data.push([
        type_assurance, time, Nom, Prenom, emailShape, Tel, date_de_naissance,
        Code_postale, Type_de_permis, Type_usage, Type_habitation, Qualite_occupation,
        Type_conducteur, Nature_pret
      ]);
    }
  }

  // Write the data to the sheet
  if (data.length > 0) {
    sheet.getRange(2, 1, data.length, 14).setValues(data);
  }

  // Return the data as JSON
  return data;
}

// Helper function to extract value from email body based on a field
function extractValueFromBody(body, field) {
  var pattern = new RegExp(field.replace(/'/g, "\\'") + "\\s*:\\s*(.*)", "i");
  var match = body.match(pattern);
  
  if (match && match.length > 1) {
    var value = match[1].trim();
    return value;
  }
  
  return "";
}

// Helper function to extract email address from the email body
function extractEmailFromBody(body) {
  var emailPattern = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i;
  var match = body.match(emailPattern);
  
  if (match && match.length > 0) {
    return match[0].replace(/<mailto:/, '').replace(/>/, '');
  }
  
  return "";
}
